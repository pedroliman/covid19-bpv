---
title: "COVID-19 Mitigation vs. Suppression Social Distancing"
author:
- name: Sarah Nowak, Pedro de Lima, Raffaele Vardavas 
  affiliation: RAND Corporation
#bibliography: ../../WriteUp/COVID-19.bib
date: "`r format(Sys.time(), '%B %d, %Y')`"
#output: html_notebook
output:
  rmdformats::readthedown
pandoc_args: --natbib
biblio-style: plain
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
remove(list = ls())
# Needed packages to perform the analysis
load <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
} 

packages <- c("knitr","kableExtra","rmdformats","rmarkdown","dplyr","here","DiagrammeR",
              "ggplot2","scales","ggthemes","bvpSolve","deSolve")
load(packages)
```

# Introducton

# Single Compartment SIR Model


We have $t = \frac{\tau}{\gamma}$, $s = S/N$, $i = I/N$,
\begin{equation}
\dot{s}= -R_\tau si,
\end{equation} where here $\dot{X}=dX/d\tau$, $R_0= \beta_\max/\gamma$,
$R_\tau=\beta(\tau)/\gamma$ and $R_{t}=R_\tau s$.


```{=tex}
\begin{equation}
\dot{i}=i (R_\tau s-1) = i (R_t-1)
\label{eq:didt}
\end{equation}
```
```{=tex}
\begin{equation}
\dot{\lambda_s}= R_{\tau} i (1 + \lambda_s-\lambda_i)
\end{equation}
```
```{=tex}
\begin{equation}
\dot{\lambda_i}= R_{\tau}s(1+\lambda_s-\lambda_i)+\lambda_i
\end{equation}
```

The full Lagrangian is:

\begin{equation}
\mathcal{L} = -c \ln\left(\frac{R_{\tau}}{R_0}\right)+c\left(\frac{R_{\tau}}{R_0}\right)+R_{\tau} si +
\lambda_s\left(\frac{d}{d \tau}{s} +R_{\tau} si\right)+
\lambda_i\left(\frac{d}{d \tau}i-R_{\tau}si+i \right)
\end{equation}

Apply equation 1 $x_i = s$

\begin{equation}
\dot{\lambda}_s = R_{\tau} i (1 + \lambda_s-\lambda_i)
\end{equation}

Apply equation 1 $x_i = i$:
\begin{equation}
\dot{\lambda}_i = R_{\tau}s(1+\lambda_s-\lambda_i)+\lambda_i
\end{equation}

Apply equation 1 $x_i = R_{\tau}$:

\begin{equation}
R_{\tau} = \frac{R_0c}{c+R_0si(1+\lambda_s-\lambda_i)}
\end{equation}

## Implementation

```{r}
oneComparmentSIR <- function(x, y, parms) {

    with(as.list(c(y, parms)),{
        s <- y[1] 
        i <- y[2] 
        lambda_s <- y[3]
        lambda_i <- y[4]
        
        R_tau = R_0*c/(c+R_0*s*i*(1+lambda_s-lambda_i))
        
        ds <- -R_tau *s *i
        
        di <- i * (R_tau*s-1)
        
        dlambda_s <- R_tau*i*(1+lambda_s-lambda_i)
        
        dlambda_i <- R_tau*s*(1+lambda_s-lambda_i)+lambda_i

    return(list(c(ds,di,dlambda_s,dlambda_i)))
    })
}
```

```{r}
R_0 <- 2.5
c <- 2e3
```

Functions for solving boundary value problems include bvptwp, bvpcol,
and bvpshoot

```{r}
i0 <- 0.03
yini = c(1-i0,i0,NA,NA)
yend = c(NA,NA,0,0)
t <- seq(0,8,1/7) ## 112 days in steps of 2 days assuming 1/gamma=14 days
```

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
sol.explore <- NULL
for (tFinal in c(4,8,16,32,64)){
    t <- seq(0,tFinal,1/7)
    
    capture.output(sol <- bvpshoot(yini = yini,yend=yend,x=t,parms = list(R_0 = R_0,c=c),func = oneComparmentSIR))

    sol <- as.data.frame(sol) %>% 
    rename(tau=x,s='1',i='2',lambda_s='3',lambda_i='4') %>% 
    mutate(R_tau = R_0*c/(c+R_0*s*i*(1+lambda_s-lambda_i)),
           Rt= R_tau*s,
           tFinal=tFinal)
    
    sol.explore  <- bind_rows(sol.explore,sol)
    
}
```

```{r}

testing <- sol.explore %>% 
    select(tau, s, tFinal) %>% 
  tidyr::gather("agg_variable", "agg_value", -tau, -tFinal)

pS<-ggplot(testing) +
  geom_line(aes(
    x = tau,
    y = agg_value,
    group = tFinal,
    colour = tFinal
  ),
  size = 1.5) +
  facet_wrap(~ agg_variable)+
  xlab("tau") +
  ylab("prev") +
  # scale_y_log10(
  #   breaks = trans_breaks("log10", function(x)
  #     10 ^ x),
  #   labels = trans_format("log10", math_format(10 ^ .x))
  # ) +
  guides(linetype = T) +
  theme_economist() +
  theme(
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16) ,
    title = element_text(size = 18) ,
    strip.text = element_text(size = 12) ,
    axis.title.x = element_text(size = 18) ,
    axis.title.y = element_text(size = 18),
    legend.text = element_text(size = 12),
    legend.title = element_blank()
  )

testing <- sol.explore %>% 
    select(tau, i, tFinal) %>% 
  tidyr::gather("agg_variable", "agg_value", -tau, -tFinal)

pI<-ggplot(testing) +
  geom_line(aes(
    x = tau,
    y = agg_value,
    group = tFinal,
    colour = tFinal
  ),
  size = 1.5) +
  facet_wrap(~ agg_variable)+
  xlab("tau") +
  ylab("Prev") +
  # scale_y_log10(
  #   breaks = trans_breaks("log10", function(x)
  #     10 ^ x),
  #   labels = trans_format("log10", math_format(10 ^ .x))
  # ) +
  guides(linetype = T) +
  theme_economist() +
  theme(
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16) ,
    title = element_text(size = 18) ,
    strip.text = element_text(size = 12) ,
    axis.title.x = element_text(size = 18) ,
    axis.title.y = element_text(size = 18),
    legend.text = element_text(size = 12),
    legend.title = element_blank()
  )

testing <- sol.explore %>% 
    select(tau, lambda_s, lambda_i, tFinal) %>% 
  tidyr::gather("agg_variable", "agg_value", -tau, -tFinal)

pLambda<-ggplot(testing) +
  geom_line(aes(
    x = tau,
    y = agg_value,
    group = tFinal,
    colour = tFinal
  ),
  size = 1.5) +
  facet_wrap(~ agg_variable)+
  xlab("day") +
  ylab("Lambda") +
  # scale_y_log10(
  #   breaks = trans_breaks("log10", function(x)
  #     10 ^ x),
  #   labels = trans_format("log10", math_format(10 ^ .x))
  # ) +
  guides(linetype = T) +
  theme_economist() +
  theme(
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16) ,
    title = element_text(size = 18) ,
    strip.text = element_text(size = 12) ,
    axis.title.x = element_text(size = 18) ,
    axis.title.y = element_text(size = 18),
    legend.text = element_text(size = 12),
    legend.title = element_blank()
  )

testing <- sol.explore %>% 
    select(tau, R_tau, Rt, tFinal) %>% 
  tidyr::gather("agg_variable", "agg_value", -tau, -tFinal)

pR<-ggplot(testing) +
  geom_line(aes(
    x = tau,
    y = agg_value,
    group = tFinal,
    colour = tFinal
  ),
  size = 1.5) +
  facet_wrap(~ agg_variable)+
  xlab("tau") +
  ylab("Reproductive number") +
  # scale_y_log10(
  #   breaks = trans_breaks("log10", function(x)
  #     10 ^ x),
  #   labels = trans_format("log10", math_format(10 ^ .x))
  # ) +
  guides(linetype = T) +
  theme_economist() +
  theme(
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16) ,
    title = element_text(size = 18) ,
    strip.text = element_text(size = 12) ,
    axis.title.x = element_text(size = 18) ,
    axis.title.y = element_text(size = 18),
    legend.text = element_text(size = 12),
    legend.title = element_blank()
  )


print(pS)
print(pI)
print(pLambda)
print(pR)
```

